<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>AR на MindAR + A-Frame</title>

  <!-- A-Frame последняя стабильная версия -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- MindAR — РАБОЧАЯ версия 2025 года (чинит чёрный экран и ошибку dummyRun) -->
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.6/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #hint {
      position: fixed;
      top: 12px; left: 12px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 9999;
      font-size: 14px;
    }
    #ui {
      position: fixed;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 12px; z-index: 9999;
    }
    .btn {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn:active { background: rgba(0,0,0,0.9); }
  </style>
</head>
<body>

<div id="hint">Нажмите на экран, чтобы включить камеру...</div>

<div id="ui" style="display:none;">
  <button class="btn" id="moveLeft">◀ Move</button>
  <button class="btn" id="moveRight">Move ▶</button>
  <button class="btn" id="rotate">Rotate</button>
  <button class="btn" id="scaleUp">＋ Size</button>
  <button class="btn" id="scaleDown">－ Size</button>
</div>

<a-scene
  embedded
  mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF: 0.0001; filterBeta: 1000"
  renderer="antialias: true; logarithmicDepthBuffer: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
  background="color: #000">

  <a-assets timeout="60000">
    <a-asset-item id="model" src="assets/model.glb"></a-asset-item>
  </a-assets>

  <!-- Камера -->
  <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

  <!-- Освещение -->
  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 1.0" position="2 4 3"></a-entity>

  <!-- Маркер 0 -->
  <a-entity mindar-image-target="targetIndex: 0">
    <!-- Красная плоскость — видно, где именно маркер -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="1" height="1" color="#FF0000" opacity="0.5"></a-plane>

    <!-- Контейнер модели -->
    <a-entity id="modelContainer"
              position="0 0.1 0"
              rotation="-90 0 0"
              scale="0.25 0.25 0.25">
      <a-gltf-model src="#model" animation-mixer></a-gltf-model>
    </a-entity>
  </a-entity>

</a-scene>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sceneEl = document.querySelector("a-scene");
    const hint = document.getElementById("hint");
    const ui = document.getElementById("ui");

    sceneEl.addEventListener("loaded", () => {
      document.body.addEventListener("click", async function startAR() {
        document.body.removeEventListener("click", startAR);
        hint.innerText = "Запуск камеры...";

        try {
          await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          const mindarSystem = sceneEl.systems["mindar-image-system"];
          await mindarSystem.start();
          hint.innerText = "Наведите камеру на маркер";
          ui.style.display = "flex";
        } catch (err) {
          console.error(err);
          hint.innerHTML = "Ошибка камеры.<br>Разрешите доступ и обновите страницу.";
        }
      });
    });

    // События маркера
    const target = document.querySelector("a-entity[mindar-image-target]");
    target.addEventListener("targetFound", () => {
      console.log("Маркер найден!");
      hint.innerText = "Маркер найден!";
      hint.style.background = "rgba(0,180,0,0.7)";
    });
    target.addEventListener("targetLost", () => {
      console.log("Маркер потерян");
      hint.innerText = "Ищем маркер...";
      hint.style.background = "rgba(0,0,0,0.5)";
    });

    // Управление моделью
    const model = () => document.getElementById("modelContainer");

    document.getElementById("moveLeft").onclick = () => {
      const p = model().getAttribute("position");
      model().setAttribute("position", {x: p.x - 0.03, y: p.y, z: p.z});
    };
    document.getElementById("moveRight").onclick = () => {
      const p = model().getAttribute("position");
      model().setAttribute("position", {x: p.x + 0.03, y: p.y, z: p.z});
    };

    let rotating = false;
    document.getElementById("rotate").onclick = () => {
      rotating = !rotating;
      if (rotating) rotateLoop();
    };
    function rotateLoop() {
      if (!rotating) return;
      const r = model().getAttribute("rotation");
      model().setAttribute("rotation", {x: r.x, y: r.y + 2, z: r.z});
      requestAnimationFrame(rotateLoop);
    }

    document.getElementById("scaleUp").onclick = () => {
      const s = model().getAttribute("scale");
      model().setAttribute("scale", {x: s.x * 1.2, y: s.y * 1.2, z: s.z * 1.2});
    };
    document.getElementById("scaleDown").onclick = () => {
      const s = model().getAttribute("scale");
      model().setAttribute("scale", {x: s.x * 0.8, y: s.y * 0.8, z: s.z * 0.8});
    };
  });
</script>
</body>
</html>